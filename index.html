<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Single Town Finder</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root {
      --bg-soft: linear-gradient(135deg, rgba(16, 185, 129, 0.14), rgba(14, 165, 233, 0.18));
      --panel-bg: rgba(255, 255, 255, 0.93);
      --text-main: #0f172a;
      --text-dim: #334155;
      --brand: #0f766e;
      --brand-dark: #115e59;
      --line: rgba(15, 23, 42, 0.12);
      --shadow: 0 20px 45px rgba(15, 23, 42, 0.22);
      --top1: #f59e0b;
      --top10: #0284c7;
      --default-dot: #64748b;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: "Space Grotesk", "Avenir Next", "Segoe UI", sans-serif;
      color: var(--text-main);
      background: #0f172a;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .panel {
      position: fixed;
      top: 14px;
      left: 14px;
      z-index: 1000;
      width: min(390px, calc(100% - 28px));
      max-height: calc(100vh - 28px);
      overflow-y: auto;
      border-radius: 16px;
      padding: 16px;
      background: var(--panel-bg);
      background-image: var(--bg-soft);
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .title {
      margin: 0;
      font-size: 1.3rem;
      line-height: 1.1;
      letter-spacing: -0.02em;
    }

    .subtitle {
      margin: 8px 0 14px;
      font-size: 0.88rem;
      line-height: 1.45;
      color: var(--text-dim);
    }

    .master-btn {
      width: 100%;
      border: 0;
      border-radius: 12px;
      padding: 12px 14px;
      font-family: inherit;
      font-size: 0.95rem;
      font-weight: 700;
      color: #ffffff;
      background: linear-gradient(120deg, var(--brand), var(--brand-dark));
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.15s ease;
      box-shadow: 0 12px 25px rgba(15, 118, 110, 0.34);
    }

    .master-btn:hover {
      transform: translateY(-1px);
    }

    .master-btn:disabled {
      opacity: 0.7;
      cursor: wait;
      transform: none;
    }

    .status {
      margin-top: 10px;
      padding: 9px 10px;
      font-size: 0.8rem;
      border-radius: 8px;
      color: #0b5b53;
      background: rgba(255, 255, 255, 0.65);
      border: 1px solid rgba(11, 91, 83, 0.2);
    }

    .slider-group {
      margin-top: 10px;
      padding: 9px 10px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.72);
      border: 1px solid rgba(15, 23, 42, 0.11);
    }

    .slider-label {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 0.78rem;
      font-weight: 700;
      color: #0f172a;
    }

    .slider-help {
      margin-top: 5px;
      font-size: 0.7rem;
      color: #475569;
      line-height: 1.3;
    }

    .slider-group input[type="range"] {
      width: 100%;
      accent-color: var(--brand);
    }

    .size-select {
      width: 100%;
      border: 1px solid rgba(15, 23, 42, 0.16);
      background: #ffffff;
      color: #0f172a;
      border-radius: 8px;
      padding: 7px 8px;
      font-family: inherit;
      font-size: 0.78rem;
      font-weight: 600;
    }

    .card {
      margin-top: 12px;
      padding: 12px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid var(--line);
      display: none;
    }

    .card.show {
      display: block;
      animation: slide-up 240ms ease-out;
    }

    .winner-row {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .winner-city {
      font-size: 1.05rem;
      font-weight: 700;
      line-height: 1.2;
    }

    .score-pill {
      flex-shrink: 0;
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 0.78rem;
      font-weight: 700;
      color: #713f12;
      background: rgba(245, 158, 11, 0.24);
      border: 1px solid rgba(180, 83, 9, 0.2);
    }

    .metric-grid {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 5px 9px;
      font-size: 0.82rem;
      color: var(--text-dim);
    }

    .metric-grid b {
      color: var(--text-main);
    }

    .top-list-title {
      margin: 0 0 8px;
      font-size: 0.88rem;
      font-weight: 700;
    }

    .town-row {
      display: block;
      font-size: 0.82rem;
      padding: 7px 8px;
      margin-bottom: 6px;
      border-radius: 8px;
      cursor: pointer;
      border: 1px solid rgba(15, 23, 42, 0.08);
      background: rgba(255, 255, 255, 0.75);
      transition: transform 0.13s ease, background-color 0.13s ease;
    }

    .town-row:hover {
      transform: translateX(2px);
      background: rgba(224, 242, 254, 0.75);
    }

    .town-topline {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
      margin-bottom: 4px;
    }

    .town-name {
      font-weight: 700;
      color: #0f172a;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .town-rank {
      color: #0369a1;
      font-weight: 700;
      margin-right: 6px;
    }

    .town-score {
      color: #0f172a;
      font-weight: 700;
    }

    .town-metrics {
      font-size: 0.74rem;
      line-height: 1.35;
      color: #334155;
    }

    .method-note {
      margin-top: 9px;
      font-size: 0.74rem;
      line-height: 1.35;
      color: #475569;
    }

    .leaflet-popup-content {
      margin: 11px 12px;
      font-family: "Space Grotesk", "Avenir Next", "Segoe UI", sans-serif;
      font-size: 0.8rem;
      line-height: 1.35;
    }

    @keyframes slide-up {
      from {
        transform: translateY(8px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @media (max-width: 860px) {
      .panel {
        width: calc(100% - 20px);
        left: 10px;
        top: 10px;
        max-height: min(85vh, 750px);
      }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <aside class="panel" aria-live="polite">
    <h1 class="title">Single Town Finder</h1>
    <p class="subtitle">Ranked strictly by Single Men / Women ratio (lowest competition).</p>
    <button id="masterBtn" class="master-btn" type="button">Find Highest-Odds Towns</button>
    <div class="slider-group">
      <div class="slider-label">
        <span>Minimum Target Pool</span>
        <span id="minTargetPopVal">0</span>
      </div>
      <input id="minTargetPopSlider" type="range" min="0" max="100000" step="1000" value="0" />
      <div class="slider-help">Move this and the ranking auto-recalculates.</div>
    </div>
    <div class="slider-group">
      <div class="slider-label">
        <span>Metro Size Focus</span>
      </div>
      <select id="sizeFocusSelect" class="size-select">
        <option value="small_medium" selected>Small + Medium (<= 1.5M)</option>
        <option value="all">All Sizes</option>
        <option value="small">Small (<= 500k)</option>
        <option value="medium">Medium (250k - 1.5M)</option>
        <option value="large">Large (>= 1.5M)</option>
      </select>
      <div class="slider-help">Set the city-size band you want to prioritize.</div>
    </div>
    <div class="slider-group">
      <div class="slider-label">
        <span>Region / Strategy Focus</span>
      </div>
      <select id="strategySelect" class="size-select">
        <option value="us" selected>US Metros</option>
        <option value="international">Intl / LatAm / East</option>
        <option value="all">Global (All)</option>
      </select>
    </div>
    <div class="slider-group">
      <div class="slider-label">
        <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
          <input type="checkbox" id="excludeMormonCheck" checked />
          Exclude Mormon Enclaves (UT/ID)
        </label>
      </div>
      <div class="slider-help">Removes highly Mormon areas like Provo, Logan, etc.</div>
    </div>

    <div class="slider-group" style="display: none;">
      <div class="slider-label">
        <span>Approaches per Day</span>
        <span id="approachRateVal">8</span>
      </div>
      <input id="approachRateSlider" type="range" min="3" max="20" step="1" value="8" />
      <div class="slider-help">How many approaches you do per active day. Affects sustainability scoring â€” higher rates need bigger pools.</div>
    </div>
    <div id="status" class="status">Loaded city data. Click the button to run the odds ranking.</div>

    <section id="winnerCard" class="card"></section>
    <section id="topListCard" class="card"></section>
  </aside>

  <script src="./city-data.js"></script>
  <script>
    const US_STATE_CODES = new Set([
      "AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "FL", "GA", "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY", "DC"
    ]);

    const COMP_WEIGHT = 1.4;
    const SUST_WEIGHT = 1.0;
    const SIGMOID_STEEPNESS = 10;
    const SUST_MIDPOINT_MONTHS = 18;
    const SUST_STEEPNESS = 0.25;
    const POOL_FLOOR = 3000;
    const ACTIVE_DAYS_PER_MONTH = 22;

    const cityByName = new Map(cityData.map((city) => [city.short_name, city]));
    const markerByCity = new Map();
    let ranking = [];
    let scoreByCity = new Map();

    const statusEl = document.getElementById("status");
    const masterBtn = document.getElementById("masterBtn");
    const minTargetPopSlider = document.getElementById("minTargetPopSlider");
    const minTargetPopVal = document.getElementById("minTargetPopVal");
    const sizeFocusSelect = document.getElementById("sizeFocusSelect");
    const approachRateSlider = document.getElementById("approachRateSlider");
    const approachRateVal = document.getElementById("approachRateVal");
    const strategySelect = document.getElementById("strategySelect");
    const excludeMormonCheck = document.getElementById("excludeMormonCheck");
    const winnerCard = document.getElementById("winnerCard");
    const topListCard = document.getElementById("topListCard");
    let autoRecalcTimer = null;

    const map = L.map("map", { zoomControl: true }).setView([39.82, -98.58], 4);
    L.tileLayer("https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png", {
      attribution: "&copy; OpenStreetMap &copy; CARTO",
      subdomains: "abcd",
      maxZoom: 20
    }).addTo(map);

    function isUSCityName(name) {
      const parts = String(name || "").split(",").map((part) => part.trim());
      if (parts.length < 2) {
        return false;
      }
      return US_STATE_CODES.has(parts[parts.length - 1]);
    }

    function toNumber(value) {
      const n = Number(value);
      return Number.isFinite(n) ? n : NaN;
    }

    function quantile(sortedValues, q) {
      if (!sortedValues.length) {
        return 0;
      }
      if (sortedValues.length === 1) {
        return sortedValues[0];
      }
      const clampedQ = Math.max(0, Math.min(1, q));
      const idx = (sortedValues.length - 1) * clampedQ;
      const lo = Math.floor(idx);
      const hi = Math.ceil(idx);
      if (lo === hi) {
        return sortedValues[lo];
      }
      const weight = idx - lo;
      return sortedValues[lo] + (sortedValues[hi] - sortedValues[lo]) * weight;
    }

    function buildStat(values) {
      const clean = values.filter((value) => Number.isFinite(value)).sort((a, b) => a - b);
      if (!clean.length) {
        return { min: 0, max: 1, median: 0.5, spread: 1 };
      }
      const min = clean[0];
      const max = clean[clean.length - 1];
      const median = quantile(clean, 0.5);
      const spread = Math.max(1e-9, max - min);
      return { min, max, median, spread };
    }

    function sigmoidCompetitionScore(comp, median, spread) {
      return 1 / (1 + Math.exp(SIGMOID_STEEPNESS * (comp - median) / spread));
    }

    function sustainabilityScore(targetPop, approachesPerDay) {
      const months = targetPop / (approachesPerDay * ACTIVE_DAYS_PER_MONTH);
      return 1 / (1 + Math.exp(-SUST_STEEPNESS * (months - SUST_MIDPOINT_MONTHS)));
    }

    function poolFloorPenalty(targetPop) {
      if (targetPop >= POOL_FLOOR) return 1;
      return Math.pow(targetPop / POOL_FLOOR, 2);
    }

    function getApproachRate() {
      const n = parseInt(approachRateSlider.value, 10);
      return Number.isFinite(n) ? Math.max(1, n) : 8;
    }

    function updateApproachRateDisplay() {
      approachRateVal.textContent = getApproachRate();
    }

    function monthsOfGame(targetPop, approachesPerDay) {
      return targetPop / (approachesPerDay * ACTIVE_DAYS_PER_MONTH);
    }

    function monthlyBurnRate(targetPop, approachesPerDay) {
      if (targetPop <= 0) return 100;
      return ((approachesPerDay * ACTIVE_DAYS_PER_MONTH) / targetPop) * 100;
    }

    function round1(value) {
      return Math.round(value * 10) / 10;
    }

    function reliabilityForCity(city) {
      const checks = [
        toNumber(city.single_w) > 0,
        toNumber(city.single_m) > 0,
        toNumber(city.single_w_18_24) > 0
      ];
      const validCount = checks.filter(Boolean).length;
      return validCount / checks.length;
    }

    function getRegionCities() {
      const strategy = strategySelect.value;
      const excludeMormon = excludeMormonCheck.checked;
      return cityData.filter((city) => {
        const isUS = isUSCityName(city.short_name);
        if (strategy === "us" && !isUS) return false;
        if (strategy === "international" && isUS) return false;
        
        if (excludeMormon) {
          const name = city.short_name.toUpperCase();
          if (name.includes(", UT") || name.includes(", ID")) return false;
        }
        
        return true;
      });
    }

    function metricValues(city) {
      const singleRatio = city.single_ratio;
      return {
        competition: singleRatio,
        targetPop: toNumber(city.single_w_18_24)
      };
    }

    function formatCount(value) {
      const n = toNumber(value);
      if (!Number.isFinite(n)) {
        return "N/A";
      }
      return Math.round(n).toLocaleString();
    }

    function formatRatio(value) {
      const n = toNumber(value);
      if (!Number.isFinite(n)) {
        return "N/A";
      }
      return n.toFixed(2);
    }

    function formatPop(value) {
      const n = toNumber(value);
      if (!Number.isFinite(n)) {
        return "N/A";
      }
      return Math.round(n).toLocaleString();
    }



    function getMinTargetPopThreshold() {
      const n = parseInt(minTargetPopSlider.value, 10);
      return Number.isFinite(n) ? Math.max(0, n) : 0;
    }

    function updateMinTargetPopDisplay() {
      minTargetPopVal.textContent = formatPop(getMinTargetPopThreshold());
    }

    function getSizeFocusValue() {
      return sizeFocusSelect.value || "all";
    }

    function getSizeFocusLabel(value = getSizeFocusValue()) {
      if (value === "small_medium") return "Small + Medium";
      if (value === "small") return "Small";
      if (value === "medium") return "Medium";
      if (value === "large") return "Large";
      return "All Sizes";
    }

    function cityMatchesSizeFocus(city) {
      const pop = toNumber(city.pop);
      if (!Number.isFinite(pop) || pop <= 0) {
        return false;
      }

      const focus = getSizeFocusValue();
      if (focus === "small_medium") {
        return pop <= 1500000;
      }
      if (focus === "small") {
        return pop <= 500000;
      }
      if (focus === "medium") {
        return pop >= 250000 && pop <= 1500000;
      }
      if (focus === "large") {
        return pop >= 1500000;
      }
      return true;
    }

    function initMinTargetPopSlider() {
      const values = getRegionCities()
        .map((city) => toNumber(city.single_w_18_24))
        .filter((value) => Number.isFinite(value) && value > 0);

      const maxObserved = values.length ? Math.max(...values) : 100000;
      const roundedMax = Math.max(10000, Math.ceil(maxObserved / 5000) * 5000);

      minTargetPopSlider.max = String(roundedMax);
      minTargetPopSlider.step = roundedMax > 120000 ? "2500" : "1000";
      minTargetPopSlider.value = "0";
      updateMinTargetPopDisplay();
    }

    function clearRankingResults() {
      ranking = [];
      scoreByCity = new Map();
      winnerCard.innerHTML = "";
      topListCard.innerHTML = "";
      winnerCard.classList.remove("show");
      topListCard.classList.remove("show");
      updateMarkersWithRanking();
    }

    function scheduleAutoRecalc() {
      if (autoRecalcTimer) {
        clearTimeout(autoRecalcTimer);
      }
      autoRecalcTimer = setTimeout(() => {
        autoRecalcTimer = null;
        runMasterRanking({ flyToTop: false, announceRunning: false });
      }, 160);
    }

    function escapeHtml(text) {
      return String(text)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function buildPopup(city, info) {
      const rankText = info ? `#${info.rank} | Score ${info.score.toFixed(1)}` : "Not ranked yet";
      const singleRatio = city.single_ratio;
      return `
        <div>
          <div style="font-weight:700; margin-bottom:4px;">${escapeHtml(city.short_name)}</div>
          <div style="font-size:11px; color:#0f172a; margin-bottom:6px;">${rankText}</div>
          <div style="font-size:11px; line-height:1.4;">
            <div><b>Target pool (Single W 18-24):</b> ${formatPop(city.single_w_18_24)}</div>
            <div><b>Competition:</b> ${Number.isFinite(singleRatio) ? singleRatio.toFixed(2) : "N/A"} Single Men (18-32) per Single Woman</div>
          </div>
        </div>
      `;
    }

    function markerStyleForRank(rank) {
      if (rank === 1) {
        return { color: "#ffffff", weight: 2, fillColor: "#f59e0b", fillOpacity: 0.95, radius: 10 };
      }
      if (rank <= 10) {
        return { color: "#ffffff", weight: 1.6, fillColor: "#0284c7", fillOpacity: 0.86, radius: 7 };
      }
      if (rank <= 50) {
        return { color: "#ffffff", weight: 1, fillColor: "#2563eb", fillOpacity: 0.55, radius: 5 };
      }
      return { color: "#ffffff", weight: 1, fillColor: "#64748b", fillOpacity: 0.4, radius: 4 };
    }

    function updateMarkersWithRanking() {
      markerByCity.forEach((marker, cityName) => {
        const city = cityByName.get(cityName);
        const info = scoreByCity.get(cityName);
        const rank = info ? info.rank : 999;
        marker.setStyle(markerStyleForRank(rank));
        marker.bindPopup(buildPopup(city, info));
      });
    }

    function runMasterRanking(options = {}) {
      const { flyToTop = true, announceRunning = true } = options;
      masterBtn.disabled = true;
      if (announceRunning) {
        statusEl.textContent = "Running scan on metros...";
      }

      const minTargetPop = getMinTargetPopThreshold();
      const approachRate = getApproachRate();

      const referenceCities = getRegionCities().filter((city) => (
        toNumber(city.single_w) > 0
        && toNumber(city.single_m) > 0
        && toNumber(city.single_w_18_24) > 0
      ));

      const usCities = referenceCities.filter((city) => (
        toNumber(city.single_w_18_24) >= minTargetPop
        && cityMatchesSizeFocus(city)
      ));

      if (!usCities.length) {
        clearRankingResults();
        statusEl.textContent = `No cities match target pool ${formatPop(minTargetPop)} with size focus ${getSizeFocusLabel()}. Adjust filters.`;
        masterBtn.disabled = false;
        return;
      }

      const prepared = usCities.map((city) => ({ city, metrics: metricValues(city) }));
      const referencePrepared = referenceCities.map((city) => ({ city, metrics: metricValues(city) }));

      const compStats = buildStat(referencePrepared.map((item) => item.metrics.competition));


      if (compStats.spread <= 1e-9) {
        clearRankingResults();
        statusEl.textContent = "Not enough metric variation to compute a ranking.";
        masterBtn.disabled = false;
        return;
      }

      ranking = prepared
        .map((item) => {
          const comp = item.metrics.competition;
          const targetPop = item.metrics.targetPop;

          const compScore = Number.isFinite(comp)
            ? sigmoidCompetitionScore(comp, compStats.median, compStats.spread)
            : 0;
            
          const finalScore = compScore;

          const reliability = reliabilityForCity(item.city);
          const score = Math.max(0, Math.min(100, finalScore * 100));

          return {
            city: item.city,
            metrics: item.metrics,
            score: round1(score),
            compScore: round1(compScore * 100),
            reliability: round1(reliability * 100)
          };
        })
        .sort((a, b) => b.score - a.score);

      scoreByCity = new Map(ranking.map((item, index) => [item.city.short_name, {
        rank: index + 1,
        score: item.score,
        reliability: item.reliability
      }]));

      updateMarkersWithRanking();
      renderResults(ranking, compStats, approachRate);

      const top = ranking[0];
      if (flyToTop) {
        map.flyTo([top.city.lat, top.city.lon], 7, { duration: 0.9 });
      }

      masterBtn.disabled = false;
    }

    function renderResults(sorted, compStats, approachRate) {
      const winner = sorted[0];
      const minTargetPop = getMinTargetPopThreshold();
      const sizeFocusLabel = getSizeFocusLabel();
      const winnerMen100 = winner.metrics.competition;
      const competitionDelta = winnerMen100 - compStats.median;

      const scarcityNote = sorted.length <= 10
        ? ` Only ${sorted.length} metros meet this floor.`
        : "";
      statusEl.textContent = `Ranked ${sorted.length} metros (target pool >= ${formatPop(minTargetPop)}, size focus: ${sizeFocusLabel}, ${approachRate} approaches/day).${scarcityNote}`;

      winnerCard.innerHTML = `
        <div class="winner-row">
          <div class="winner-city">Top Pick: ${escapeHtml(winner.city.short_name)}</div>
          <div class="score-pill">${winner.score.toFixed(1)} / 100</div>
        </div>
        <div class="metric-grid">
          <div>Competition Ratio</div><b>${Number.isFinite(winnerMen100) ? winnerMen100.toFixed(2) + " Single Men (18-32) per Single Woman (18-24)" : "N/A"} (${competitionDelta >= 0 ? "+" : ""}${competitionDelta.toFixed(2)} vs U.S. median)</b>
          <div>Target pool size</div><b>${formatCount(winner.city.single_w_18_24)}</b>
          <div>Risk / Strat</div><b>${winner.city.frat_risk} / ${winner.city.strategy}</b>
        </div>
        <div class="method-note">Linear score: cities are ranked strictly on their competition ratio via sigmoid scaling. Use the slider to filter out towns that are too small.</div>
      `;
      winnerCard.classList.add("show");

      const topRows = sorted.slice(0, 10).map((item, index) => {
        const city = item.city;
        const ratio = item.metrics.competition;

        return `
          <div class="town-row" data-city="${escapeHtml(city.short_name)}">
            <div class="town-topline">
              <div class="town-name"><span class="town-rank">#${index + 1}</span> ${escapeHtml(city.short_name)}</div>
              <div class="town-score">${item.score.toFixed(1)}</div>
            </div>
            <div class="town-metrics">
              Ratio ${Number.isFinite(ratio) ? ratio.toFixed(2) + " Single Men/Woman" : "N/A"} &middot; Target Pool: ${formatPop(city.single_w_18_24)}<br>
              Strat: ${city.strategy ? city.strategy.split(' ')[0] : 'None'}
            </div>
          </div>
        `;
      }).join("");

      topListCard.innerHTML = `
        <h2 class="top-list-title">Top 10 Towns (${sizeFocusLabel}, Pool >= ${formatPop(minTargetPop)})</h2>
        <div class="method-note" style="margin-top:0; margin-bottom:8px;">Ranked strictly by competition odds. Click a row to zoom and open map details.</div>
        ${topRows}
      `;
      topListCard.classList.add("show");

      topListCard.querySelectorAll(".town-row").forEach((row) => {
        row.addEventListener("click", () => {
          const cityName = row.getAttribute("data-city");
          const city = cityByName.get(cityName);
          const marker = markerByCity.get(cityName);
          if (!city || !marker) {
            return;
          }
          map.flyTo([city.lat, city.lon], 8, { duration: 0.75 });
          marker.openPopup();
        });
      });
    }

    function initMarkers() {
      cityData.forEach((city) => {
        const lat = toNumber(city.lat);
        const lon = toNumber(city.lon);
        if (!Number.isFinite(lat) || !Number.isFinite(lon)) {
          return;
        }
        const marker = L.circleMarker([lat, lon], {
          color: "#ffffff",
          weight: 1,
          fillColor: "#64748b",
          fillOpacity: 0.4,
          radius: 4
        }).addTo(map);

        marker.bindPopup(buildPopup(city, null));
        markerByCity.set(city.short_name, marker);
      });

      statusEl.textContent = `Loaded ${markerByCity.size} global metros. Set target pool and size focus, then click the button (or adjust controls to auto-recalculate).`;
    }



    strategySelect.addEventListener("change", () => {
      runMasterRanking({ flyToTop: false, announceRunning: true });
    });

    excludeMormonCheck.addEventListener("change", () => {
      runMasterRanking({ flyToTop: false, announceRunning: true });
    });

    minTargetPopSlider.addEventListener("input", () => {
      updateMinTargetPopDisplay();
      scheduleAutoRecalc();
    });

    minTargetPopSlider.addEventListener("change", () => {
      if (autoRecalcTimer) {
        clearTimeout(autoRecalcTimer);
        autoRecalcTimer = null;
      }
      runMasterRanking({ flyToTop: false, announceRunning: true });
    });

    sizeFocusSelect.addEventListener("change", () => {
      runMasterRanking({ flyToTop: false, announceRunning: true });
    });

    approachRateSlider.addEventListener("input", () => {
      updateApproachRateDisplay();
      scheduleAutoRecalc();
    });

    approachRateSlider.addEventListener("change", () => {
      if (autoRecalcTimer) {
        clearTimeout(autoRecalcTimer);
        autoRecalcTimer = null;
      }
      runMasterRanking({ flyToTop: false, announceRunning: true });
    });

    masterBtn.addEventListener("click", () => runMasterRanking({ flyToTop: true, announceRunning: true }));
    initMinTargetPopSlider();
    initMarkers();
  </script>
</body>
</html>
